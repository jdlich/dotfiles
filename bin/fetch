#!/usr/bin/env ruby

#
# TODO: Adding new tarfiles to fetch and repositories to checkout will eventually lead to a need for another level 
# of abstraction. Currently, the specific shell commands are being abstracted ie 'unpack', etc, but that's not 
# enough (and might be unneccesary). A better abstraction would be on resource type ie tarball, svn repo, regular 
# download (jquery plugin), etc. Examples:
#
# def tarfile url
#   download
#   unpack
#   remove
# end
# 
# def svn url
#   checkout
#   remove_svn (optional)
# end
# 
# def zipfile url
#   download
#   unzip
# end
# 
# Fetch.new(url, :type => :tar)
# Fetch.new(url, :type => :svn)
# Fetch.new(url, :type => :zip)
# 
# This came out of need (or desire) to not ever have to hunt down a url for a code library again (at least not 
# twice). I also don't want to store stuff on my computer or copy stuff from older projects. 'What's that plugin I 
# used for that one project...'. Enter fetch. Download popular jquery plugins, common repos, tomcat, etc and inject 
# straight into the directories you want with a single command.
#

require 'clamp'

class Fetch < Clamp::Command
  option "--no-svn", :flag, "remove .svn files"

  # uPortal
  subcommand "uportal", "Checkout uPortal 3.x from source repo" do
    def execute
      svn "https://source.jasig.org/uPortal/branches/rel-3-2-patches/" 
      remove_recursive('.svn') if no_svn?
    end
  end
  
  # Tomcat
  subcommand "tomcat", "Download and unpack tomcat 6" do
    parameter "[VERSION]", "tomcat version"
    
    def execute
      tomcat = case version
      when "5"
        "http://archive.apache.org/dist/tomcat/tomcat-5/v5.5.20-original/bin/apache-tomcat-5.5.20.tar.gz"
      else
        "http://archive.apache.org/dist/tomcat/tomcat-6/v6.0.29/bin/apache-tomcat-6.0.29.tar.gz"
      end
      download tomcat
      tarfile = tomcat.split("/").last
      unpack tarfile
      remove tarfile
    end
  end
  
  # CAS
  subcommand "cas", "Checkout CAS 3.x from source repo" do
    def execute
      svn "https://source.jasig.org/cas3/branches/cas-3_4_x_maintenance/cas-server-3.4.2/"
      remove_recursive('.svn') if no_svn?
    end
  end
  
  # Sakai
  subcommand "sakai", "Checkout Sakai CLE" do
    def execute
      svn "https://source.sakaiproject.org/svn/sakai/branches/sakai-2.7.1/"
      remove_recursive('.svn') if no_svn?
    end
  end
  
  private
  
  def remove file
    system "rm -rf #{file}"
  end
  
  def remove_recursive file
    system "rm -r **/#{file}"
  end
  
  def unpack tar
    system "tar -xvzf #{tar}"
  end
  
  def download url
    system "curl -O #{url}"
  end
  
  def svn repo
    system "svn co #{repo}"
  end
end

Fetch.run